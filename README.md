# Conversations Push Proxy
A [XEP-0357: Push Notifications](https://xmpp.org/extensions/xep-0357.html) app server that relays push messages between the user’s server and Googles Firebase Cloud Messaging.

## Background
Due to restrictions in Firebase Cloud Messaging (and most other push services) only the developer can create push notifications for theirs apps. For this reason a user’s server wouldn’t be able to wake up a user’s device directly but has to proxy that wake up signal through the infrastructure of the app developer.

Here is a quick description of how this relationship is set up.

### What Conversations sends to the app server

* FCM Token: The FCM token is essentially the address of the device that will be used to address push notifications to. That address can change over time. The address is generated by the Google Play Service on the user’s phone. Conversations has no influence over how and when this is (re)generated and can only request it.

* Secure Device Id: Since the FCM token can change over time the app server needs a second unique ID per device so when it receives a new FCM token it knows whether this one replaces an existing device or is for an entirely new device. Conversations uses the [Android ID](https://developer.android.com/reference/android/provider/Settings.Secure.html#ANDROID_ID) which is a unique string that is generated by the Android operating system and persists over the life time of the app. In older versions of Android this used to be shared across all apps. Nowadays every app gets its own ID generated by the OS.

* The app server then generates a random string (Node ID in the language of the XEP) and stores a combination of the FCM Token, the node id, the domain of the account (not the entire account) and a hashed string of the account jid + the secure device id. Since the account jid is essentially *salted* with the secure device id the app server operator won’t be able to reverse the account jids by looking at the database.
The node id is sent back to the client.

```
<iq to="p2.siacs.eu" from="d…l@g…h.de/Conversations.XYZa">
  <command xmlns="http://jabber.org/protocol/commands" node="register-push-fcm" action="execute">
    <x xmlns="jabber:x:data" type="submit">
      <field var="android-id"><value>123c0ffee</value></field>
      <field var="token"><value>somethingrandom</value></field>
    </x>
  </command>
</iq>
```

### What Conversatations sends to the user’s server

After registrating with the App server Conversations sends the node ID and the jid of the app server (p2.siacs.eu) to the users server.

```
<iq type='set' id='x42'>
  <enable xmlns='urn:xmpp:push:0' jid='p2.siacs.eu' node='random-node-id' />
</iq> 
```

### What the user’s server sends to the app server

When a push is required (this is determined with internal logic of the user’s server that is out of scope of this document) the user’s server will send the node id to the app server. The user’s server *can* also add additonal information like number of messages pending, the sender jid of the last message and even the body of the last message. Whether or not this information is included is up to the implementation and the configuration of the user’s server and is out of scope for this document as well. Whether or not the app server receives that additional information it will just ignore it and not process it.
The sender jid for the push is the the jid of the server. Since the app server didn’t store the account jid and since the account jid is not included in the push it won’t know for which account the push is actually for. It will just be able to look up the corresponding FCM token based on the node id.

An example of that communication can be fonud in [XEP-0357 Section 7](https://xmpp.org/extensions/xep-0357.html#publishing).

### What the app server sends via Google to the user’s device

Upon receiving a push from a server the app server looks up the hashed account jid + secure device id combination and the FCM token and sends the hash to the token (Rember token means device address in FCM language).

The hash can then be used by Conversations to determine which of a number of accounts should be woken up. The hash is not reversible but since Conversations has a limited number of accounts and also knows the secure device id it can just calculate all hashes. Google only sees that hash and nothing else.

```
{'to':'fcm-token','data':{'account':'hashed account jid + device id'}}
```

## Setup

### Build from source
```
git checkout https://github.com/iNPUTmice/p2.git
cd p2
mvn packege
```

### Install
```
cp target/p1-0.1.jar /opt
cp p2.conf.example /etc/p2.conf
mkdir /var/lib/p2
useradd -d /var/lib/p2 -r p2
chown -R p2:p2 /var/lib/p2
cp dist/p2.service /etc/systemd/system
systemctl daemon-reload
systemctl enable p2.service
systemctl start p2.service
```
